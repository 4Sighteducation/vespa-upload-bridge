<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student CSV Email Test</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #007bff;
            padding-bottom: 10px;
        }
        .test-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .test-button.success {
            background: #28a745;
        }
        .test-button.danger {
            background: #dc3545;
        }
        .log-output {
            background: #1e1e1e;
            color: #fff;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #666;
        }
        .log-entry.info { border-left-color: #007bff; }
        .log-entry.success { border-left-color: #28a745; }
        .log-entry.error { border-left-color: #dc3545; }
        .log-entry.warning { border-left-color: #ffc107; }
        
        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        .comparison-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            border: 2px solid #dee2e6;
        }
        .comparison-box.working {
            border-color: #28a745;
        }
        .comparison-box.not-working {
            border-color: #dc3545;
        }
        .comparison-box h3 {
            margin-top: 0;
        }
        pre {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .status-indicator.active {
            background: #28a745;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <h1>üîç Student CSV Welcome Email Investigation</h1>
    
    <div class="test-section">
        <h2>Test Configuration</h2>
        <div>
            <label>API Base URL:</label>
            <input type="text" id="apiUrl" value="https://vespa-upload-api-20ac5c3cf3e3.herokuapp.com/api/" style="width: 400px; padding: 5px;">
        </div>
        <div style="margin-top: 10px;">
            <label>Test Email:</label>
            <input type="email" id="testEmail" value="test@example.com" style="width: 300px; padding: 5px;">
        </div>
    </div>

    <div class="test-section">
        <h2>Scenario Comparison</h2>
        <p>Testing the difference between working (Manual) and non-working (CSV) scenarios:</p>
        
        <div class="comparison-grid">
            <div class="comparison-box working">
                <h3>‚úÖ Working: Manual Entry</h3>
                <button class="test-button success" onclick="testManualEntry()">Test Manual Student Entry</button>
                <pre id="manualPayload">Ready to test...</pre>
                <div id="manualResult"></div>
            </div>
            
            <div class="comparison-box not-working">
                <h3>‚ùå Not Working: CSV Upload</h3>
                <button class="test-button danger" onclick="testCSVUpload()">Test CSV Student Upload</button>
                <pre id="csvPayload">Ready to test...</pre>
                <div id="csvResult"></div>
            </div>
        </div>
    </div>

    <div class="test-section">
        <h2>Advanced Tests</h2>
        <button class="test-button" onclick="testWithDifferentFlags()">Test Different Flag Combinations</button>
        <button class="test-button" onclick="testBatchSizes()">Test Batch Size Impact</button>
        <button class="test-button" onclick="checkEmailEndpoint()">Check Email Service Status</button>
    </div>

    <div class="test-section">
        <h2>Console Output</h2>
        <div class="log-output" id="logOutput">
            <div class="log-entry info">üîç Investigation tool ready. Click a test button to begin...</div>
        </div>
    </div>

    <script>
        // Logging helper
        function log(message, type = 'info') {
            const logOutput = document.getElementById('logOutput');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.innerHTML = `<span class="status-indicator ${type === 'info' ? 'active' : ''}"></span>[${timestamp}] ${message}`;
            logOutput.appendChild(entry);
            logOutput.scrollTop = logOutput.scrollHeight;
        }

        // Test Manual Entry (Working)
        async function testManualEntry() {
            log('Testing Manual Student Entry...', 'info');
            
            const payload = {
                csvData: [{
                    'Firstname': 'Test',
                    'Lastname': 'Manual',
                    'Student Email': document.getElementById('testEmail').value,
                    'Year Gp': '12',
                    'Level': 'Level 3',
                    'UPN': 'MANUAL' + Date.now()
                }],
                options: {
                    sendNotifications: true,
                    notificationEmail: document.getElementById('testEmail').value,
                    percentile: '75',
                    manualEntry: true  // KEY DIFFERENCE
                },
                context: {
                    userId: 'test_user',
                    userEmail: 'admin@test.com',
                    customerId: 'test_customer'
                }
            };
            
            document.getElementById('manualPayload').textContent = JSON.stringify(payload, null, 2);
            log('Manual entry payload prepared', 'success');
            
            // Log what we're looking for
            log('Key flag: manualEntry = true', 'warning');
            
            try {
                // Simulate API call (replace with actual if needed)
                log('Would send to: ' + document.getElementById('apiUrl').value + 'students/onboard/process', 'info');
                document.getElementById('manualResult').innerHTML = '<p style="color: green;">‚úÖ Manual entry typically works</p>';
            } catch (error) {
                log('Error: ' + error.message, 'error');
            }
        }

        // Test CSV Upload (Not Working)
        async function testCSVUpload() {
            log('Testing CSV Student Upload...', 'info');
            
            const payload = {
                csvData: [{
                    'Firstname': 'Test',
                    'Lastname': 'CSV',
                    'Student Email': document.getElementById('testEmail').value,
                    'Year Gp': '12',
                    'Level': 'Level 3',
                    'UPN': 'CSV' + Date.now()
                }],
                options: {
                    sendNotifications: true,
                    notificationEmail: document.getElementById('testEmail').value,
                    percentile: '75',
                    manualEntry: false  // KEY DIFFERENCE
                },
                context: {
                    userId: 'test_user',
                    userEmail: 'admin@test.com',
                    customerId: 'test_customer'
                }
            };
            
            document.getElementById('csvPayload').textContent = JSON.stringify(payload, null, 2);
            log('CSV upload payload prepared', 'success');
            
            // Log what we're looking for
            log('Key flag: manualEntry = false', 'warning');
            
            try {
                // Simulate API call (replace with actual if needed)
                log('Would send to: ' + document.getElementById('apiUrl').value + 'students/onboard/process', 'info');
                document.getElementById('csvResult').innerHTML = '<p style="color: red;">‚ùå CSV upload not sending emails</p>';
            } catch (error) {
                log('Error: ' + error.message, 'error');
            }
        }

        // Test different flag combinations
        function testWithDifferentFlags() {
            log('Testing different flag combinations...', 'info');
            
            const tests = [
                { manualEntry: true, sendNotifications: true, desc: 'Manual + Notifications' },
                { manualEntry: false, sendNotifications: true, desc: 'CSV + Notifications' },
                { manualEntry: false, sendNotifications: false, desc: 'CSV + No Notifications' },
                { manualEntry: undefined, sendNotifications: true, desc: 'Undefined Manual + Notifications' }
            ];
            
            tests.forEach(test => {
                log(`Testing: ${test.desc} - manualEntry=${test.manualEntry}, sendNotifications=${test.sendNotifications}`, 'info');
            });
            
            log('üí° Hypothesis: Backend might check for manualEntry===true specifically', 'warning');
        }

        // Test batch size impact
        function testBatchSizes() {
            log('Testing batch size impact...', 'info');
            
            const batchSizes = [1, 5, 10, 50, 100];
            
            batchSizes.forEach(size => {
                log(`Testing batch size: ${size} students`, 'info');
                if (size === 1) {
                    log('  Single record (like manual) - might work', 'success');
                } else if (size > 50) {
                    log('  Large batch - might skip emails for performance', 'warning');
                }
            });
            
            log('üí° Backend might have batch size limits for email sending', 'warning');
        }

        // Check email service
        function checkEmailEndpoint() {
            log('Checking email service status...', 'info');
            log('Typical email services to check:', 'info');
            log('  - SendGrid API status', 'info');
            log('  - SMTP configuration', 'info');
            log('  - Rate limiting', 'info');
            log('  - Daily/hourly limits', 'info');
            
            log('üí° Check if SendGrid has different handling for bulk vs single emails', 'warning');
        }

        // Key insights
        setTimeout(() => {
            log('=== KEY INSIGHTS ===', 'warning');
            log('1. Both Manual and CSV use same endpoint: students/onboard/process', 'warning');
            log('2. Main difference is the manualEntry flag in options', 'warning');
            log('3. Backend likely has conditional logic: if (options.manualEntry) { sendEmail() }', 'error');
            log('4. Solution: Remove the conditional or ensure CSV also sends emails', 'success');
        }, 2000);
    </script>
</body>
</html>
