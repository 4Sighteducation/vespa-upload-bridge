<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VESPA Student Self-Registration</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #f0f2f5;
            color: #1a1a1a;
            line-height: 1.6;
            min-height: 100vh;
            position: relative;
            -webkit-font-smoothing: antialiased;
        }
        
        .container {
            max-width: 100%;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            background: white;
        }
        
        .header {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .school-name {
            font-size: 16px;
            opacity: 0.9;
        }
        
        .form-container {
            padding: 20px;
            max-width: 500px;
            margin: 0 auto;
        }
        
        .custom-message {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            font-size: 14px;
            color: #1565c0;
        }
        
        .form-group {
            margin-bottom: 24px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
            font-size: 16px;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #fafafa;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        
        .form-group select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath fill='%23333' d='M6 8L0 0h12z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            padding-right: 40px;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #007bff;
            background: white;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        .help-text {
            font-size: 13px;
            color: #666;
            margin-top: 6px;
        }
        
        .error-text {
            font-size: 13px;
            color: #dc3545;
            margin-top: 6px;
            display: none;
        }
        
        /* Staff Selection Button */
        .staff-select-button {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            background: #fafafa;
            cursor: pointer;
            text-align: left;
            transition: all 0.3s ease;
            position: relative;
            min-height: 52px;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 6px;
        }
        
        .staff-select-button:hover {
            border-color: #007bff;
            background: white;
        }
        
        .staff-select-button:focus {
            outline: none;
            border-color: #007bff;
            background: white;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }
        
        .staff-select-button .placeholder {
            color: #999;
            flex: 1;
        }
        
        .staff-select-button .arrow {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
            transition: transform 0.3s ease;
        }
        
        /* Selected Staff Tags */
        .selected-badge {
            background: #007bff;
            color: white;
            padding: 4px 10px;
            border-radius: 16px;
            font-size: 13px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin: 2px;
        }
        
        .selected-badge .remove {
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            line-height: 1;
            opacity: 0.8;
            transition: opacity 0.2s;
        }
        
        .selected-badge .remove:hover {
            opacity: 1;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }
        
        .modal.active {
            display: flex;
            align-items: flex-end;
            justify-content: center;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content {
            background: white;
            width: 100%;
            max-width: 500px;
            max-height: 80vh;
            border-radius: 20px 20px 0 0;
            animation: slideUp 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
            position: relative;
            flex-shrink: 0;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            margin: 0;
        }
        
        .modal-close {
            position: absolute;
            right: 20px;
            top: 20px;
            font-size: 28px;
            color: #666;
            cursor: pointer;
            line-height: 1;
            transition: color 0.2s;
        }
        
        .modal-close:hover {
            color: #333;
        }
        
        .modal-search {
            padding: 0 20px 20px;
            flex-shrink: 0;
        }
        
        .search-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            background: #fafafa;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #007bff;
            background: white;
        }
        
        .modal-body {
            padding: 0 20px 20px;
            overflow-y: auto;
            flex: 1;
            -webkit-overflow-scrolling: touch;
        }
        
        .staff-item {
            padding: 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: #fafafa;
        }
        
        .staff-item:hover {
            border-color: #007bff;
            background: white;
        }
        
        .staff-item.selected {
            border-color: #007bff;
            background: #e3f2fd;
        }
        
        .staff-checkbox {
            width: 24px;
            height: 24px;
            border: 2px solid #666;
            border-radius: 6px;
            position: relative;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }
        
        .staff-item.selected .staff-checkbox {
            background: #007bff;
            border-color: #007bff;
        }
        
        .staff-checkbox::after {
            content: '';
            position: absolute;
            left: 7px;
            top: 3px;
            width: 6px;
            height: 12px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .staff-item.selected .staff-checkbox::after {
            opacity: 1;
        }
        
        .staff-info {
            flex: 1;
        }
        
        .staff-name {
            font-size: 16px;
            font-weight: 500;
            color: #333;
            margin-bottom: 2px;
        }
        
        .staff-details {
            font-size: 13px;
            color: #666;
        }
        
        .modal-footer {
            padding: 20px;
            border-top: 1px solid #e0e0e0;
            flex-shrink: 0;
            background: #fafafa;
        }
        
        .modal-button {
            width: 100%;
            padding: 14px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        .modal-button:hover {
            background: #0056b3;
        }
        
        /* Submit Button */
        .submit-button {
            width: 100%;
            padding: 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.2);
        }
        
        .submit-button:hover {
            background: #0056b3;
            box-shadow: 0 6px 20px rgba(0, 123, 255, 0.3);
        }
        
        .submit-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            box-shadow: none;
        }
        
        /* Loading and Messages */
        .loading {
            display: none;
            text-align: center;
            padding: 40px 20px;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .message {
            padding: 16px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
            font-size: 15px;
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .expired-message {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        
        /* Mobile Optimizations */
        @media (max-width: 400px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 20px;
            }
            
            .form-container {
                padding: 16px;
            }
        }
        
        /* iOS Specific Fixes */
        @supports (-webkit-touch-callout: none) {
            input, select, textarea {
                font-size: 16px !important;
            }
        }
        
        /* No results message */
        .no-results {
            text-align: center;
            padding: 40px 20px;
            color: #666;
            font-size: 16px;
        }
        
        /* Success Screen Styles */
        #success-screen {
            text-align: center;
            padding: 40px 20px;
            max-width: 500px;
            margin: 0 auto;
        }
        
        .success-icon {
            font-size: 60px;
            margin-bottom: 20px;
        }
        
        #success-screen h2 {
            color: #28a745;
            font-size: 28px;
            margin-bottom: 30px;
        }
        
        .credentials-box {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 25px;
            text-align: left;
        }
        
        .credentials-box p {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .credential-row {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: white;
            border-radius: 8px;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .credential-row label {
            font-weight: 600;
            min-width: 80px;
            color: #495057;
            flex-shrink: 0;
        }
        
        .credential-row span {
            flex: 1;
            font-family: monospace;
            font-size: 14px;
            color: #333;
            word-break: break-all;
            min-width: 0;
        }
        
        #display-email {
            font-size: 13px;
        }
        
        .password-display {
            background: #fff3cd;
            padding: 8px 12px;
            border-radius: 6px;
            border: 2px solid #ffc107;
            font-weight: 600;
            font-size: 16px;
            letter-spacing: 0.5px;
        }
        
        .copy-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 5px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        
        .copy-button:hover {
            background: #0056b3;
        }
        
        .login-button {
            width: 100%;
            max-width: 300px;
            padding: 16px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }
        
        .login-button:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }
        
        .security-note {
            font-size: 14px;
            color: #6c757d;
            font-style: italic;
        }
        
        /* Mobile-specific adjustments for success screen */
        @media (max-width: 500px) {
            .credentials-box {
                padding: 20px 15px;
            }
            
            .credential-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
            
            .credential-row label {
                min-width: auto;
                margin-bottom: 3px;
            }
            
            .credential-row span {
                width: 100%;
            }
            
            .password-display {
                display: inline-block;
                width: auto;
                max-width: 100%;
            }
            
            .copy-button {
                margin-top: 8px;
                width: 100%;
            }
            
            #success-screen h2 {
                font-size: 24px;
            }
            
            .success-icon {
                font-size: 48px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>VESPA Student Registration</h1>
            <div class="school-name" id="school-name">Loading...</div>
        </div>
        
        <div class="form-container">
            <div id="custom-message" class="custom-message" style="display: none;"></div>
            
            <div id="expired-message" class="expired-message" style="display: none;">
                <h2>Registration Link Expired</h2>
                <p>This registration link has expired. Please contact your school administrator for a new link.</p>
            </div>
            
            <div id="success-message" class="message success-message"></div>
            <div id="error-message" class="message error-message"></div>
            
            <form id="registration-form" style="display: none;">
                <div class="form-row">
                    <div class="form-group">
                        <label for="firstname">First Name *</label>
                        <input type="text" id="firstname" name="firstname" required autocomplete="given-name">
                        <div class="error-text" id="firstname-error"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="lastname">Last Name *</label>
                        <input type="text" id="lastname" name="lastname" required autocomplete="family-name">
                        <div class="error-text" id="lastname-error"></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="email">Email Address *</label>
                    <input type="email" id="email" name="email" required placeholder="Use your school email address" autocomplete="email">
                    <div class="help-text">Please use your official school/college email address only</div>
                    <div class="error-text" id="email-error"></div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="year-group">Current Year Group *</label>
                        <select id="year-group" name="yearGroup" required>
                            <option value="">Select year group</option>
                            <option value="9">Year 9</option>
                            <option value="10">Year 10</option>
                            <option value="11">Year 11</option>
                            <option value="12">Year 12</option>
                            <option value="13">Year 13</option>
                            <option value="UGrad">Undergraduate</option>
                        </select>
                        <div class="error-text" id="year-group-error"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="tutor-group">Tutor Group</label>
                        <input type="text" id="tutor-group" name="tutorGroup" placeholder="e.g., 12A, 13B">
                        <div class="help-text">Enter to filter tutors</div>
                        <div class="error-text" id="tutor-group-error"></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="tutors">Tutor(s) *</label>
                    <button type="button" class="staff-select-button" id="tutors-button">
                        <span class="placeholder" id="tutors-placeholder">Select your tutor(s)</span>
                        <span class="arrow">‚ñº</span>
                    </button>
                    <div class="help-text" id="tutors-help">Select one or more tutors</div>
                    <div class="error-text" id="tutors-error"></div>
                </div>
                
                <div class="form-group" id="hoy-group">
                    <label for="head-of-year">Head(s) of Year</label>
                    <button type="button" class="staff-select-button" id="hoy-button">
                        <span class="placeholder" id="hoy-placeholder">Select head(s) of year</span>
                        <span class="arrow">‚ñº</span>
                    </button>
                    <div class="error-text" id="hoy-error"></div>
                </div>
                
                <div class="form-group" id="teachers-group">
                    <label for="subject-teachers">Subject Teachers</label>
                    <button type="button" class="staff-select-button" id="teachers-button">
                        <span class="placeholder" id="teachers-placeholder">Select subject teachers</span>
                        <span class="arrow">‚ñº</span>
                    </button>
                    <div class="help-text">You can select multiple teachers</div>
                    <div class="error-text" id="teachers-error"></div>
                </div>
                
                <div class="form-group">
                    <label for="gender">Gender *</label>
                    <select id="gender" name="gender" required>
                        <option value="">Select gender</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                        <option value="Prefer not to say">Prefer not to say</option>
                    </select>
                    <div class="error-text" id="gender-error"></div>
                </div>
                
                <button type="submit" class="submit-button" id="submit-button">Register</button>
            </form>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Processing your registration...</p>
            </div>
            
            <!-- Success Screen with Password Display -->
            <div id="success-screen" style="display: none;">
                <div class="success-icon">‚úÖ</div>
                <h2>Registration Complete!</h2>
                <div class="credentials-box">
                    <p><strong>Your Login Details:</strong></p>
                    <div class="credential-row">
                        <label>Email:</label>
                        <span id="display-email"></span>
                    </div>
                    <div class="credential-row">
                        <label>Password:</label>
                        <div style="flex: 1; display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                            <span id="display-password" class="password-display"></span>
                            <button onclick="copyPassword()" class="copy-button">üìã Copy</button>
                        </div>
                    </div>
                </div>
                <button id="login-button" class="login-button">
                    Go to VESPA Login ‚Üí
                </button>
                <p class="security-note">
                    ‚ö†Ô∏è Save these details - they've also been emailed to you
                </p>
            </div>
        </div>
    </div>
    
    <!-- Staff Selection Modal -->
    <div class="modal" id="staff-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modal-title">Select Staff</h2>
                <span class="modal-close" id="modal-close">&times;</span>
            </div>
            <div class="modal-search">
                <input type="text" class="search-input" id="modal-search" placeholder="Search by name...">
            </div>
            <div class="modal-body" id="modal-body">
                <!-- Staff items will be inserted here -->
            </div>
            <div class="modal-footer">
                <button class="modal-button" id="modal-done">Done</button>
            </div>
        </div>
    </div>
    
    <script>
        // Global variables
        let linkData = null;
        let linkId = null;
        let qrLinkId = null;
        let staffData = {
            tutors: [],
            headsOfYear: [],
            subjectTeachers: []
        };
        let selectedData = {
            tutors: [],
            headsOfYear: [],
            subjectTeachers: []
        };
        let allTutors = [];
        let currentModalType = null;
        
        // Free email domains to block
        const freeEmailDomains = [
            'gmail.com', 'yahoo.com', 'hotmail.com', 'outlook.com', 'aol.com',
            'icloud.com', 'mail.com', 'protonmail.com', 'yandex.com', 'zoho.com'
        ];
        
        // Helper function to strip HTML tags from text
        function stripHtml(html) {
            const tmp = document.createElement('DIV');
            tmp.innerHTML = html;
            return tmp.textContent || tmp.innerText || '';
        }
        
        // Helper function to extract email from HTML anchor tag
        function extractEmail(emailString) {
            if (!emailString) return '';
            
            // If it's already a plain email, return it
            if (emailString.includes('@') && !emailString.includes('<')) {
                return emailString.trim();
            }
            
            // Extract email from anchor tag
            const match = emailString.match(/mailto:([^"'>]+)/);
            if (match) {
                return match[1].trim();
            }
            
            // Try to extract email from the string
            const emailMatch = emailString.match(/([a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\.[a-zA-Z0-9_-]+)/);
            if (emailMatch) {
                return emailMatch[1].trim();
            }
            
            return stripHtml(emailString).trim();
        }
        
        // Helper function to format name for display
        function formatStaffName(staff) {
            if (staff.displayName) return staff.displayName;
            if (staff.name) return staff.name;
            
            // Try to combine prefix and surname
            let name = '';
            if (staff.prefix) name += staff.prefix + ' ';
            if (staff.surname) name += staff.surname;
            
            // If we have a name, return it
            if (name.trim()) return name.trim();
            
            // Last resort: use email
            const email = extractEmail(staff.email);
            return email.split('@')[0]; // Return the part before @
        }
        
        // Load staff data from API
        async function loadStaffData() {
            console.log('=== SIMPLE LOAD STAFF DATA START ===');
            
            if (!linkData || !linkData.customerId) {
                console.error('No customerId available');
                showError('Unable to load staff data. Customer information is missing.');
                return;
            }
            
            const customerId = linkData.customerId;
            console.log('Using customerId:', customerId);
            
            try {
                const API_URL = 'https://vespa-upload-api-07e11c285370.herokuapp.com/api';
                const url = `${API_URL}/self-registration/staff-list?customerId=${customerId}`;
                console.log('Fetching from:', url);
                
                const response = await fetch(url);
                console.log('Response status:', response.status);
                
                const data = await response.json();
                console.log('Response data:', data);
                
                if (data.success) {
                    // Process staff data to clean emails
                    staffData.tutors = (data.tutors || []).map(processStaffMember);
                    staffData.headsOfYear = (data.headsOfYear || []).map(processStaffMember);
                    staffData.subjectTeachers = (data.subjectTeachers || []).map(processStaffMember);
                    allTutors = [...staffData.tutors];
                    
                    console.log('Staff data loaded:', {
                        tutors: staffData.tutors.length,
                        hoy: staffData.headsOfYear.length,
                        teachers: staffData.subjectTeachers.length
                    });
                    
                                            // Update button texts
                        updateButtonText('tutors', staffData.tutors.length > 0 ? 'Select your tutor(s)' : 'No tutors available');
                        updateButtonText('headsOfYear', staffData.headsOfYear.length > 0 ? 'Select head(s) of year' : 'No heads of year available');
                        updateButtonText('subjectTeachers', staffData.subjectTeachers.length > 0 ? 'Select subject teachers' : 'No teachers available');
                    
                    // Hide sections if no data
                    if (staffData.headsOfYear.length === 0) {
                        document.getElementById('hoy-group').style.display = 'none';
                    }
                    if (staffData.subjectTeachers.length === 0) {
                        document.getElementById('teachers-group').style.display = 'none';
                    }
                } else {
                    throw new Error(data.message || 'Failed to load staff data');
                }
            } catch (error) {
                console.error('=== LOAD STAFF DATA ERROR ===');
                console.error('Error:', error);
                showError('Unable to load staff information. Please refresh the page and try again.');
            }
        }
        
        // Fallback method using XMLHttpRequest if fetch fails
        function loadStaffDataFallback(customerId) {
            console.log('Using XMLHttpRequest fallback for staff data...');
            
            const xhr = new XMLHttpRequest();
            const API_URL = 'https://vespa-upload-api-07e11c285370.herokuapp.com/api';
            const url = `${API_URL}/self-registration/staff-list?customerId=${customerId}&_t=${Date.now()}`;
            
            xhr.open('GET', url, true);
            xhr.setRequestHeader('Accept', 'application/json');
            xhr.setRequestHeader('Cache-Control', 'no-cache');
            xhr.withCredentials = true; // Include credentials for CORS
            
            xhr.onload = function() {
                if (xhr.status === 200) {
                    try {
                        const data = JSON.parse(xhr.responseText);
                        console.log('Staff data received via XHR:', data);
                        
                        // Process the data
                        staffData.tutors = (data.tutors || []).map(processStaffMember);
                        staffData.headsOfYear = (data.headsOfYear || []).map(processStaffMember);
                        staffData.subjectTeachers = (data.subjectTeachers || []).map(processStaffMember);
                        allTutors = [...staffData.tutors];
                        
                        // Update UI
                        updateButtonText('tutors', staffData.tutors.length > 0 ? 'Select your tutor(s)' : 'No tutors available');
                        updateButtonText('headsOfYear', staffData.headsOfYear.length > 0 ? 'Select head(s) of year' : 'No heads of year available');
                        updateButtonText('subjectTeachers', staffData.subjectTeachers.length > 0 ? 'Select subject teachers' : 'No teachers available');
                        
                        // Hide sections if no data
                        if (staffData.headsOfYear.length === 0) {
                            document.getElementById('hoy-group').style.display = 'none';
                        }
                        if (staffData.subjectTeachers.length === 0) {
                            document.getElementById('teachers-group').style.display = 'none';
                        }
                        
                        console.log('Staff data loaded successfully via XHR');
                    } catch (e) {
                        console.error('Error parsing XHR response:', e);
                        showError('Failed to load staff information.');
                    }
                } else {
                    console.error('XHR failed with status:', xhr.status);
                    showError('Failed to load staff information.');
                }
            };
            
            xhr.onerror = function() {
                console.error('XHR network error');
                showError('Network error loading staff information.');
            };
            
            xhr.send();
        }
        
        // Process staff member data
        function processStaffMember(staff) {
            // Backend now returns clean emails and proper displayName
            const cleanEmail = extractEmail(staff.email);
            return {
                ...staff,
                email: cleanEmail,
                displayName: staff.displayName || formatStaffName(staff),
                prefix: staff.prefix || '',
                firstname: staff.firstname || '',
                lastname: staff.lastname || ''
            };
        }
        
        // Update button text
        function updateButtonText(type, text) {
            // Map type names to placeholder IDs
            const placeholderIdMap = {
                tutors: 'tutors-placeholder',
                hoy: 'hoy-placeholder',
                headsOfYear: 'hoy-placeholder',
                teachers: 'teachers-placeholder',
                subjectTeachers: 'teachers-placeholder'
            };
            
            const placeholderId = placeholderIdMap[type] || `${type}-placeholder`;
            const placeholder = document.getElementById(placeholderId);
            if (placeholder) {
                placeholder.textContent = text;
            }
        }
        
        // Setup event listeners
        function setupEventListeners() {
            // Form submission
            document.getElementById('registration-form').addEventListener('submit', handleSubmit);
            
            // Year group change
            document.getElementById('year-group').addEventListener('change', handleYearGroupChange);
            
            // Tutor group input
            document.getElementById('tutor-group').addEventListener('input', handleTutorGroupChange);
            
            // Staff selection buttons
            document.getElementById('tutors-button').addEventListener('click', () => openModal('tutors'));
            document.getElementById('hoy-button').addEventListener('click', () => openModal('headsOfYear'));
            document.getElementById('teachers-button').addEventListener('click', () => openModal('subjectTeachers'));
            
            // Modal controls
            document.getElementById('modal-close').addEventListener('click', closeModal);
            document.getElementById('modal-done').addEventListener('click', closeModal);
            document.getElementById('modal-search').addEventListener('input', handleModalSearch);
            
            // Close modal on background click
            document.getElementById('staff-modal').addEventListener('click', (e) => {
                if (e.target.id === 'staff-modal') {
                    closeModal();
                }
            });
            
            // Email validation
            document.getElementById('email').addEventListener('blur', validateEmail);
            
            // Prevent zoom on input focus (iOS)
            const inputs = document.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                input.addEventListener('focus', () => {
                    document.querySelector('meta[name="viewport"]').setAttribute('content', 
                        'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no');
                });
            });
        }
        
        // Handle year group change
        function handleYearGroupChange() {
            document.getElementById('tutor-group').value = '';
            filterTutors('');
        }
        
        // Handle tutor group change
        function handleTutorGroupChange(e) {
            const tutorGroup = e.target.value.trim();
            filterTutors(tutorGroup);
        }
        
        // Filter tutors based on group
        function filterTutors(tutorGroup) {
            const tutorGroupLower = tutorGroup.toLowerCase();
            let filteredTutors = allTutors;
            
            if (tutorGroup) {
                // Filter tutors by group
                filteredTutors = allTutors.filter(tutor => {
                    if (!tutor.group) return false;
                    return tutor.group.toLowerCase().includes(tutorGroupLower);
                });
                
                // If no matches, try partial matches
                if (filteredTutors.length === 0) {
                    filteredTutors = allTutors.filter(tutor => {
                        if (!tutor.group) return false;
                        const tutorGroupLower = tutor.group.toLowerCase();
                        return tutorGroupLower.split(/[\s,.-]+/).some(part => 
                            tutorGroup.toLowerCase().split(/[\s,.-]+/).some(inputPart => 
                                part.includes(inputPart) || inputPart.includes(part)
                            )
                        );
                    });
                }
            }
            
            // Update the stored tutor data
            staffData.tutors = filteredTutors.length > 0 ? filteredTutors : allTutors;
            
            // Update help text
            const helpText = document.getElementById('tutors-help');
            if (tutorGroup && filteredTutors.length > 0 && filteredTutors.length < allTutors.length) {
                helpText.textContent = `Showing ${filteredTutors.length} tutor(s) for group "${tutorGroup}"`;
            } else {
                helpText.textContent = 'Select one or more tutors';
            }
        }
        
        // Open modal
        function openModal(type) {
            currentModalType = type;
            const modal = document.getElementById('staff-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            const searchInput = document.getElementById('modal-search');
            
            // Set title
            const titles = {
                tutors: 'Select Tutors',
                headsOfYear: 'Select Heads of Year',
                subjectTeachers: 'Select Subject Teachers'
            };
            modalTitle.textContent = titles[type];
            
            // Clear search
            searchInput.value = '';
            
            // Render staff list
            renderStaffList(staffData[type]);
            
            // Show modal
            modal.classList.add('active');
            
            // Focus search input
            setTimeout(() => searchInput.focus(), 300);
        }
        
        // Close modal
        function closeModal() {
            const modal = document.getElementById('staff-modal');
            modal.classList.remove('active');
            updateSelectionDisplay(currentModalType);
        }
        
        // Handle modal search
        function handleModalSearch(e) {
            const searchTerm = e.target.value.toLowerCase();
            const staffList = staffData[currentModalType];
            
            const filtered = staffList.filter(staff => {
                const name = staff.displayName.toLowerCase();
                const email = staff.email.toLowerCase();
                const group = (staff.group || '').toLowerCase();
                return name.includes(searchTerm) || email.includes(searchTerm) || group.includes(searchTerm);
            });
            
            renderStaffList(filtered);
        }
        
        // Render staff list in modal
        function renderStaffList(staffList) {
            const modalBody = document.getElementById('modal-body');
            modalBody.innerHTML = '';
            
            if (staffList.length === 0) {
                modalBody.innerHTML = '<div class="no-results">No staff members found</div>';
                return;
            }
            
            staffList.forEach(staff => {
                const div = document.createElement('div');
                div.className = 'staff-item';
                if (selectedData[currentModalType].includes(staff.email)) {
                    div.classList.add('selected');
                }
                
                let details = '';
                if (currentModalType === 'tutors' && staff.group) {
                    details = `Group: ${staff.group}`;
                }
                // Only show email if we don't have a proper name
                else if (staff.email && staff.displayName === staff.email.split('@')[0]) {
                    details = staff.email;
                }
                
                div.innerHTML = `
                    <div class="staff-checkbox"></div>
                    <div class="staff-info">
                        <div class="staff-name">${staff.displayName}</div>
                        ${details ? `<div class="staff-details">${details}</div>` : ''}
                    </div>
                `;
                
                div.addEventListener('click', () => toggleStaffSelection(staff));
                modalBody.appendChild(div);
            });
        }
        
        // Toggle staff selection
        function toggleStaffSelection(staff) {
            const index = selectedData[currentModalType].indexOf(staff.email);
            
            if (index > -1) {
                selectedData[currentModalType].splice(index, 1);
            } else {
                selectedData[currentModalType].push(staff.email);
            }
            
            // Re-render the list to update checkboxes
            handleModalSearch({ target: document.getElementById('modal-search') });
        }
        
        // Update selection display
        function updateSelectionDisplay(type) {
            // Map type names to button IDs
            const buttonIdMap = {
                tutors: 'tutors-button',
                headsOfYear: 'hoy-button',
                subjectTeachers: 'teachers-button'
            };
            
            const placeholderIdMap = {
                tutors: 'tutors-placeholder',
                headsOfYear: 'hoy-placeholder',
                subjectTeachers: 'teachers-placeholder'
            };
            
            const button = document.getElementById(buttonIdMap[type]);
            const placeholder = document.getElementById(placeholderIdMap[type]);
            
            if (!button || !placeholder) {
                console.error('Button or placeholder not found for type:', type);
                return;
            }
            
            // Clear current content
            const existingBadges = button.querySelectorAll('.selected-badge');
            existingBadges.forEach(badge => badge.remove());
            
            if (selectedData[type].length === 0) {
                placeholder.style.display = 'block';
                placeholder.textContent = {
                    tutors: 'Select your tutor(s)',
                    headsOfYear: 'Select head(s) of year',
                    subjectTeachers: 'Select subject teachers'
                }[type];
            } else {
                placeholder.style.display = 'none';
                
                selectedData[type].forEach(email => {
                    const staff = staffData[type].find(s => s.email === email);
                    if (staff) {
                        const badge = document.createElement('span');
                        badge.className = 'selected-badge';
                        
                        // Create text node for the display name
                        const nameText = document.createTextNode(staff.displayName);
                        badge.appendChild(nameText);
                        
                        // Create the remove button
                        const removeBtn = document.createElement('span');
                        removeBtn.className = 'remove';
                        removeBtn.textContent = '√ó';
                        removeBtn.setAttribute('data-email', email);
                        removeBtn.setAttribute('data-type', type);
                        
                        removeBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            removeSelection(type, email);
                        });
                        
                        badge.appendChild(removeBtn);
                        button.insertBefore(badge, button.querySelector('.arrow'));
                    }
                });
            }
        }
        
        // Remove selection
        function removeSelection(type, email) {
            const index = selectedData[type].indexOf(email);
            if (index > -1) {
                selectedData[type].splice(index, 1);
                updateSelectionDisplay(type);
            }
        }
        
        // Validate email
        function validateEmail() {
            const email = document.getElementById('email').value.trim();
            const emailError = document.getElementById('email-error');
            
            if (!email) {
                emailError.style.display = 'none';
                return true;
            }
            
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                emailError.textContent = 'Please enter a valid email address';
                emailError.style.display = 'block';
                return false;
            }
            
            const domain = email.split('@')[1].toLowerCase();
            if (linkData?.configSettings?.requireSchoolEmail && freeEmailDomains.includes(domain)) {
                emailError.textContent = 'Please use your school email address, not a personal email';
                emailError.style.display = 'block';
                return false;
            }
            
            // Add warning for free email domains (even if not strictly required)
            if (!linkData?.configSettings?.requireSchoolEmail && freeEmailDomains.includes(domain)) {
                // Check if we've already warned about this email
                const warningKey = `email_warning_${email}`;
                if (!sessionStorage.getItem(warningKey)) {
                    const userConfirmed = confirm(
                        'We strongly recommend using your school or college email address instead of a personal email.\n\n' +
                        'School email addresses help ensure you receive important communications and maintain proper access.\n\n' +
                        'Do you want to continue with this personal email address?'
                    );
                    
                    if (!userConfirmed) {
                        emailError.textContent = 'Please use your school or college email address';
                        emailError.style.display = 'block';
                        return false;
                    } else {
                        // Remember that we've warned about this email during this session
                        sessionStorage.setItem(warningKey, 'true');
                    }
                }
            }
            
            emailError.style.display = 'none';
            return true;
        }
        
        // Handle form submission
        async function handleSubmit(e) {
            e.preventDefault();
            
            // Clear messages
            document.getElementById('success-message').style.display = 'none';
            document.getElementById('error-message').style.display = 'none';
            
            // Validate form
            if (!validateForm()) {
                return;
            }
            
            // Show loading
            document.getElementById('loading').style.display = 'block';
            document.getElementById('submit-button').disabled = true;
            document.getElementById('registration-form').style.display = 'none';
            
            const formData = {
                firstname: document.getElementById('firstname').value.trim(),
                lastname: document.getElementById('lastname').value.trim(),
                email: document.getElementById('email').value.trim(),
                yearGroup: document.getElementById('year-group').value,
                tutorGroup: document.getElementById('tutor-group').value.trim(),
                tutors: selectedData.tutors,
                headsOfYear: selectedData.headsOfYear,
                subjectTeachers: selectedData.subjectTeachers,
                gender: document.getElementById('gender').value,
                linkId: linkId,
                qrLinkId: qrLinkId
            };
            
            try {
                const API_URL = 'https://vespa-upload-api-07e11c285370.herokuapp.com/api';
                const response = await fetch(`${API_URL}/self-registration/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData),
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Registration failed');
                }
                
                const result = await response.json();
                
                // Check if we have credentials to display
                if (result.credentials) {
                    // Hide loading
                    document.getElementById('loading').style.display = 'none';
                    
                    // Show success screen with password
                    document.getElementById('display-email').textContent = result.credentials.email;
                    document.getElementById('display-password').textContent = result.credentials.password;
                    
                    // Set up login button
                    document.getElementById('login-button').onclick = function() {
                        // Open login page with email pre-filled
                        window.location.href = result.credentials.loginUrl;
                    };
                    
                    // Show success screen
                    document.getElementById('success-screen').style.display = 'block';
                } else {
                    // Traditional success message
                    showSuccess('Registration successful! You will receive an email with your login details shortly.');
                    
                    // Reset form
                    document.getElementById('registration-form').reset();
                    selectedData = { tutors: [], headsOfYear: [], subjectTeachers: [] };
                    updateSelectionDisplay('tutors');
                    updateSelectionDisplay('headsOfYear');
                    updateSelectionDisplay('subjectTeachers');
                }
                
            } catch (error) {
                console.error('Registration error:', error);
                
                // Check if it's a duplicate email error and show the specific message
                if (error.message && error.message.includes('already exists')) {
                    showError(error.message); // Use the specific error message from backend
                } else if (error.message) {
                    showError(error.message); // Show any other specific error message
                } else {
                    showError('Registration failed. Please try again or contact your school administrator.');
                }
                
                document.getElementById('registration-form').style.display = 'block';
            } finally {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('submit-button').disabled = false;
            }
        }
        
        // Validate form
        function validateForm() {
            let isValid = true;
            
            // Required fields
            const requiredFields = ['firstname', 'lastname', 'email', 'year-group', 'gender'];
            
            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                const errorElement = document.getElementById(`${fieldId}-error`);
                
                if (!field.value.trim()) {
                    errorElement.textContent = 'This field is required';
                    errorElement.style.display = 'block';
                    isValid = false;
                } else {
                    errorElement.style.display = 'none';
                }
            });
            
            // Validate email
            if (!validateEmail()) {
                isValid = false;
            }
            
            // Validate tutors
            if (selectedData.tutors.length === 0) {
                const tutorsError = document.getElementById('tutors-error');
                tutorsError.textContent = 'Please select at least one tutor';
                tutorsError.style.display = 'block';
                isValid = false;
            } else {
                document.getElementById('tutors-error').style.display = 'none';
            }
            
            return isValid;
        }
        
        // Show success message
        function showSuccess(message) {
            const successDiv = document.getElementById('success-message');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            window.scrollTo(0, 0);
        }
        
        // Show error message
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            window.scrollTo(0, 0);
        }
        
        // Copy password to clipboard
        function copyPassword() {
            const password = document.getElementById('display-password').textContent;
            
            if (navigator.clipboard && window.isSecureContext) {
                // Modern way
                navigator.clipboard.writeText(password).then(() => {
                    const button = event.target;
                    const originalText = button.textContent;
                    button.textContent = '‚úì Copied!';
                    button.style.background = '#28a745';
                    
                    setTimeout(() => {
                        button.textContent = originalText;
                        button.style.background = '#007bff';
                    }, 2000);
                }).catch(err => {
                    fallbackCopy(password);
                });
            } else {
                // Fallback for older browsers or non-HTTPS
                fallbackCopy(password);
            }
        }
        
        // Fallback copy method
        function fallbackCopy(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                document.execCommand('copy');
                const button = event.target;
                button.textContent = '‚úì Copied!';
                setTimeout(() => {
                    button.textContent = 'üìã Copy';
                }, 2000);
            } catch (err) {
                alert('Please copy manually: ' + text);
            }
            
            document.body.removeChild(textArea);
        }
        
        // Initialize the form
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Initializing form...');
            
            // Parse URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            linkId = urlParams.get('id');
            
            if (!linkId) {
                showError('Invalid registration link. Please contact your school administrator.');
                return;
            }
            
            try {
                // Validate link
                const API_URL = 'https://vespa-upload-api-07e11c285370.herokuapp.com/api';
                const response = await fetch(`${API_URL}/self-registration/validate-link/${linkId}`, {
                    credentials: 'include'
                });
                const result = await response.json();
                
                if (!response.ok || !result.success) {
                    if (response.status === 400 && result.message?.includes('expired')) {
                        document.getElementById('expired-message').style.display = 'block';
                    } else {
                        showError(result.message || 'Invalid registration link.');
                    }
                    return;
                }
                
                // Store link data
                linkData = result;
                qrLinkId = result.qrLinkId;
                
                // Debug: Check what fields are in the result
                console.log('=== LINK VALIDATION RESULT ===');
                console.log('Result object keys:', Object.keys(result));
                console.log('Full result object:', JSON.stringify(result, null, 2));
                console.log('result.customerId:', result.customerId);
                console.log('result.data?.customerId:', result.data?.customerId);
                
                // If customerId is nested in data property, extract it
                if (!linkData.customerId && linkData.data?.customerId) {
                    linkData.customerId = linkData.data.customerId;
                    console.log('Extracted customerId from data property:', linkData.customerId);
                }
                
                console.log('Link data stored successfully:', {
                    linkData: linkData,
                    customerId: linkData?.customerId,
                    customerName: linkData?.customerName,
                    hasConfigSettings: !!linkData?.configSettings
                });
                
                // Set school name
                document.getElementById('school-name').textContent = result.customerName || 'Your School';
                
                // Add logo if available
                if (result.logoUrl) {
                    const logoHtml = `<img src="${result.logoUrl}" alt="School Logo" style="max-height: 60px; margin-bottom: 10px;">`;
                    document.querySelector('.header').insertAdjacentHTML('afterbegin', logoHtml);
                }
                
                // Show custom message
                if (result.configSettings?.customMessage) {
                    document.getElementById('custom-message').textContent = result.configSettings.customMessage;
                    document.getElementById('custom-message').style.display = 'block';
                }
                
                // Show form
                document.getElementById('registration-form').style.display = 'block';
                
                // Load staff data and setup listeners
                console.log('About to load staff data in 100ms...');
                setTimeout(async () => {
                    console.log('Timer triggered, loading staff data...');
                    try {
                        // First try with fetch
                        await loadStaffData();
                        console.log('Staff data loaded successfully');
                    } catch (fetchError) {
                        console.error('Fetch method failed:', fetchError);
                        
                        // Try fallback method with XMLHttpRequest
                        const customerId = linkData?.customerId || linkData?.data?.customerId;
                        if (customerId) {
                            console.log('Attempting XMLHttpRequest fallback...');
                            loadStaffDataFallback(customerId);
                        } else {
                            console.error('Cannot use fallback - no customerId available');
                            showError('Unable to load staff information. Please refresh and try again.');
                        }
                    }
                    
                    // Always setup event listeners
                    console.log('Setting up event listeners...');
                    setupEventListeners();
                    console.log('Event listeners setup complete');
                }, 100);
                
            } catch (error) {
                console.error('Initialization error:', error);
                showError('Unable to initialize registration form. Please try again.');
            }
        });
    </script>
</body>
</html>
